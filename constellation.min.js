(function(e,t,n,r){"use strict";var i=this,s;i.exports?s=i.exports:s=i.Const={};var o=s.utils={keys:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t},empty:function(e){if(e instanceof Array)e.length=0;else for(var t in e)e.hasOwnProperty(t)&&delete e[t];return e},size:function(e){if(e instanceof Array)return e.length;var t=0;for(var n in e)e.hasOwnProperty(n)&&t++;return t},contains:function(e,t){if(e instanceof Array){if(typeof Array.prototype.indexOf=="function")return e.indexOf(t)>=0;var n=e.length,r=0;while(r<n)if(e[r++]===t)return!0}return e.hasOwnProperty(t)},each:function(e,t,n){var r=0;if(e instanceof Array){var i=e.length;while(r<i)t.call(n,e[r],r++)}else for(r in e)e.hasOwnProperty(r)&&t.call(n,e[r],r);return e},map:function(e,t,n){var r=0;if(e instanceof Array){var i=e.length;while(r<i)e[r]=t.call(n,e[r],r++)}else for(r in e)e.hasOwnProperty(r)&&(e[r]=t.call(n,e[r],r));return e},all:function(e,t,n){var r=e.length,i=0;while(i<r)if(!t.call(n,e[i],i++))return!1;return!0}},u=s.Point=function(e,t){this.x=e||0,this.y=t||0},a=s.Rect=function(e,t,n,r){this.x=e||0,this.y=t||0,this.width=n||0,this.height=r||0};s.distance=function(t,n){var r=n.x-t.x,i=n.y-t.y;return e(r*r+i*i)},s.ccw=function(e,t,n,r){return r?(n.y-e.y)*(t.x-e.x)>(t.y-e.y)*(n.x-e.x):(n.y-e.y)*(t.x-e.x)>=(t.y-e.y)*(n.x-e.x)},s.intersect=function(e,t,n,r){return this.ccw(e,n,r)!==this.ccw(t,n,r)&&this.ccw(e,t,n)!==this.ccw(e,t,r)},s.getRectForPointRing=function(e){var r=e[0],i=r.x,s=r.x,u=r.y,f=r.y;return o.each(e,function(e){i=t(i,e.x),s=n(s,e.x),u=t(u,e.y),f=n(f,e.y)}),new a(i,u,s-i,f-u)},s.hitTestRect=function(e,r){var i=t(r.x,r.x+r.width),s=n(r.x,r.x+r.width),o=t(r.y,r.y+r.height),u=n(r.y,r.y+r.height);return e.x>=i&&e.y>=o&&e.x<=s&&e.y<=u},s.hitTestPointRing=function(e,n){var r=n.length,i=new s.Point(0,e.y),o=0,u=0,a,f;while(u<r)a=n[u],f=n[(u+1)%r],i.x=t(i.x,t(a.x,f.x)-1),o+=this.intersect(i,e,a,f)?1:0,u++;return o%2>0},s.snapPointToLineSegment=function(e,t,n){var r=e.x-t.x,i=e.y-t.y,o=n.x-t.x,u=n.y-t.y,a=o*o+u*u,f=r*o+i*u,l=f/a;return l<0?new s.Point(t.x,t.y):l>1?new s.Point(n.x,n.y):new s.Point(t.x+o*l,t.y+u*l)},s.getNearestPointToPoint=function(e,t){var n=t.length-1,i,o,u=null,a=NaN;t.sort(function(t,n){return t=r(e.x-t.x),n=r(e.x-n.x),n-t});while(n>=0){i=t[n--];if(!(r(e.x-i.x)<a||isNaN(a)))break;o=s.distance(e,i);if(o<a||isNaN(a))u=i,a=o}return u};var f=s.Node=function(e,t,n,r,i){this.id=e,this.x=t||0,this.y=n||0,this.to=i||{},this.data=r||null},l=s.Polygon=function(e,t,n){this.id=e,this.nodes=t.slice(),this.data=n||null},c=s.Path=function(e,t,n){this.nodes=e||[],this.weight=t||0,this.estimate=n||0};c.prototype={copy:function(e,t){return new c(this.nodes.slice(),e||this.weight,t||this.estimate)},last:function(){return this.nodes[this.nodes.length-1]},contains:function(e){return o.contains(e)},prioratize:function(e,t){return t.estimate-e.estimate},dispose:function(){this.nodes.length=0,this.nodes=null}};var h=s.Grid=function(e,t){this.nodes={},this.polys={},this.icount=0,this.setData(e,t)};h.prototype={events:{ADD:"add",REMOVE:"remove",CHANGE:"update"},types:{NODE:"n",POLYGON:"p"},reset:function(){o.empty(this.nodes),o.empty(this.polys),this.icount=0},setData:function(e,t){this.reset(),o.each(e||[],function(e){this.nodes[e.id]=e},this),o.each(t||[],function(e){this.polys[e.id]=e},this)},addNode:function(e,t,n,r){var i=new f(this.types.NODE+this.icount++,e,t,n);return this.nodes[i.id]=i,this.update(!0,r),i.id},getNodeById:function(e){return this.nodes.hasOwnProperty(e)?this.nodes[e]:null},getNodesForIds:function(e){return o.map(e.slice(),function(e){return this.nodes[e]},this)},getNumNodes:function(){return o.size(this.nodes)},hasNode:function(e){return this.nodes.hasOwnProperty(e)},hasNodes:function(e){return o.all(e,function(e){return this.nodes.hasOwnProperty(e)},this)},joinNodes:function(e,t){var n=!1;return e.length>1&&this.hasNodes(e)&&o.each(e,function(t){var r=this.nodes[t],i=e.length,s=0;while(s<i)t=e[s++],t!==r.id&&(r.to[t]=1,n=!0)},this),this.update(n,t),n},splitNodes:function(e,t){var n=!1;return e.length<2?this.detachNodes(e):(o.each(e,function(t){var r=this.nodes[t];if(r&&r.to)for(t in r.to)o.contains(e,t)&&(delete r.to[t],n=!0)},this),this.update(n,t),n)},detachNodes:function(e,t){var n=!1;return o.each(e,function(e){var t=this.nodes[e],r,i;if(t&&t.to){for(i in t.to)delete t.to[i],r=this.nodes[i],r&&r.to&&delete r.to[e];n=!0}},this),this.update(n,t),n},removeNodes:function(e,t){var n=this.detachNodes(e,!0);return o.each(e,function(e){var t,r;if(this.nodes.hasOwnProperty(e)){delete this.nodes[e];for(r in this.polys)t=this.polys[r],t&&o.contains(t.nodes,e)&&delete this.polys[r];n=!0}},this),this.update(n,t),n},addPolygon:function(e,t,n){var r;return e.length>=3&&this.hasNodes(e)?(r=new l(this.types.POLYGON+this.icount++,e,t),this.polys[r.id]=r,this.update(!0,n),r.id):null},getPolygonById:function(e){return this.polys.hasOwnProperty(e)?this.polys[e]:null},getNodesForPolygon:function(e){return this.polys.hasOwnProperty(e)?o.map(this.polys[e].nodes.slice(),function(e){return this.nodes[e]},this):null},getNumPolygons:function(){return o.size(this.polys)},removePolygons:function(e,t){var n=!1;return o.each(e,function(e){this.polys.hasOwnProperty(e)&&(delete this.polys[e],n=!0)},this),this.update(n,t),n},update:function(e,t){(e||e===undefined)&&!t&&this.trigger(this.events.CHANGE)},findPath:function(e,t,n,r){var i=[],o={},u,a,f,l,h,p,d=this.getNodeById(e),v=this.getNodeById(t),m=0,g;typeof n!="function"&&(n=s.distance),typeof r!="function"&&(r=s.distance),i.push(new c([d],n(d,d)));while(i.length>0){a=i.pop(),d=a.last();for(g in d.to)if(d.to.hasOwnProperty(g)){f=this.nodes[g];if(!!f&&!a.contains(f)){h=a.weight+n(d,f);if(h<=(o[f.id]||h)){o[f.id]=h,p=h+r(f,v);if(!u||p<u.weight)l=a.copy(h,p),l.nodes.push(f),f.id===v.id?(u&&u.dispose(),u=l):i.push(l),l=null}}f=null}a.dispose(),a=d=null,i.sort(c.prototype.prioratize),m++}return i=o=v=null,{valid:!!u,weight:u?u.weight:0,cycles:m,nodes:u?u.nodes:[]}},findPathWithFewestNodes:function(e,t){function n(){return 1}return this.findPath(e,t,n,n)},snapPointToGrid:function(e){var t=null,n=NaN,r={};return o.each(this.nodes,function(i,o){if(e.id!==o)for(var u in i.to)if(i.to.hasOwnProperty(u)&&!r.hasOwnProperty(u+" "+i.id)){var a=this.nodes[u],f=s.snapPointToLineSegment(e,i,a),l=s.distance(e,f);r[i.id+" "+a.id]=!0;if(!t||l<n)t=f,n=l}},this),t||e},getNearestNodeToNode:function(e){var t=null,n=[],r=this.getNodeById(e);return r&&(o.each(this.nodes,function(e){e.id!==r.id&&n.push(e)},this),t=s.getNearestPointToPoint(r,n),n.length=0),t},getNearestNodeToPoint:function(e){var t=[];return o.each(this.nodes,function(e){t.push(e)},this),e=s.getNearestPointToPoint(e,t),t.length=0,e},hitTestPointInPolygons:function(e){for(var t in this.polys)if(this.polys.hasOwnProperty(t)&&s.hitTestPointRing(e,this.getNodesForPolygon(t)))return!0;return!1},getPolygonHitsForPoint:function(e){var t=[];return o.each(this.polys,function(n,r){s.hitTestPointRing(e,this.getNodesForPolygon(r))&&t.push(n.id)},this),t},getNodesInPolygon:function(e){var t=[],n=this.getPolygonById(e),r=this.getNodesForPolygon(e),i=s.getRectForPointRing(r);return n&&o.each(this.nodes,function(e){s.hitTestRect(e,i)&&!o.contains(n.nodes,e.id)&&s.hitTestPointRing(e,r)&&t.push(e.id)},this),t},getNodesInRect:function(e){var t=[];return o.each(this.nodes,function(n){s.hitTestRect(n,e)&&t.push(n.id)},this),t}},function(e,t){var n=/\s+/;e.on=e.bind=function(e,t,r){var i,s,o;if(!t)return this;e=e.split(n),i=this._callbacks||(this._callbacks={});while(s=e.shift())o=i[s]||(i[s]=[]),o.push(t,r);return this},e.off=e.unbind=function(e,r,i){var s,o,u,a;if(!(o=this._callbacks))return this;if(!(e||r||i))return delete this._callbacks,this;e=e?e.split(n):t.keys(o);while(s=e.shift()){if(!(u=o[s])||!r&&!i){delete o[s];continue}for(a=u.length-2;a>=0;a-=2)r&&u[a]!==r||i&&u[a+1]!==i||u.splice(a,2)}return this},e.trigger=e.emit=function(e){var t,r,i,s,o,u,a,f;if(!(r=this._callbacks))return this;f=[],e=e.split(n);for(s=1,o=arguments.length;s<o;s++)f[s-1]=arguments[s];while(t=e.shift()){if(a=r.all)a=a.slice();if(i=r[t])i=i.slice();if(i)for(s=0,o=i.length;s<o;s+=2)i[s].apply(i[s+1]||this,f);if(a){u=[t].concat(f);for(s=0,o=a.length;s<o;s+=2)a[s].apply(a[s+1]||this,u)}}return this}}(s.Grid.prototype,s.utils),typeof define=="function"&&typeof define.amd=="object"&&define(s)}).call(this,Math.sqrt,Math.min,Math.max,Math.abs);