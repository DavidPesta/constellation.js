define(["lib/jquery","lib/underscore","lib/backbone","mod/grid-model","mod/grid-selection-model","mod/service-window"],function(e,t,n,r,i,s){var o=n.View.extend({el:"#grid",model:r,selectedViews:[],lastTouch:0,events:{mousedown:"onTouch"},initialize:function(){var n=this;n.tmpl=t.template(e("#grid-view").html()),r.on(r.events.CHANGE,n.render,n),r.on("change:width change:height",n.setFrame,n),s.on(s.RESIZE,n.setFrame,n),i.on(i.UPDATE,n.setSelection,n),n.setFrame()},getPathForNodes:function(e){var n="";return t.each(e,function(e,t){n+=(t<=0?"M":"L")+e.x+" "+e.y+" "}),n+"Z"},render:function(){var e=this,n={},i={},s=r.nodes,o,u;t.each(r.polys,function(t,n){i[t.id]={id:t.id,nodes:t.nodes.join(" "),d:e.getPathForNodes(r.getNodesForPolygon(t.id))}}),t.each(s,function(e,t){for(u in e.to)e.to.hasOwnProperty(u)&&s.hasOwnProperty(u)&&(o=s[u],n.hasOwnProperty(o.id+" "+e.id)||(n[e.id+" "+o.id]={id:e.id+" "+o.id,x1:e.x,y1:e.y,x2:o.x,y2:o.y}))}),this.$el.html(this.tmpl({nodes:s,lines:n,polys:i})),this.selectedViews.length=0,this.setSelection()},setFrame:function(){var e=r.get("width"),t=r.get("height"),n=e?"auto":10,i=45;this.$el.width(e).css({marginLeft:n,marginRight:n}),n=t?(s.height-i-t)/2:10,t=t?t:s.height-i-n*2,this.$el.height(t).css({marginTop:i+n})},clearSelection:function(){t.each(this.selectedViews,function(t){t=e(t),t.is("li")?t.removeClass("select").children(":first-child").text(""):t[0].setAttribute("class",t[0].getAttribute("class").replace(/[\s]?select[\s]?/g,""))}),this.selectedViews.length=0},setSelection:function(){var n=this;this.clearSelection(),t.each(i.items,function(e,t){e=n.$el.find("#"+e),e.is("li")?e.addClass("select").children(":first-child").text(t+1):e[0].setAttribute("class",e[0].getAttribute("class")+" select"),n.selectedViews.push(e[0])});if(i.path.length){var r=[];for(var s=0,o=i.path.length-1;s<o;s++)r.push("line."+i.path[s]+"."+i.path[s+1]);e(r.join(",")).each(function(){this.setAttribute("class",this.getAttribute("class")+" select"),n.selectedViews.push(this)})}},localizeEventOffset:function(e){var t=this.$el.offset();return t.left=e.pageX-t.left,t.top=e.pageY-t.top,t},drag:function(t,n,r){var i=this,s=!1;e(document).on("mouseup",function(t){return e(document).off("mouseup mousemove"),typeof n=="function"&&n(i.localizeEventOffset(t)),typeof r=="function"&&r(s),!1}).on("mousemove",function(e){return s=!0,t(i.localizeEventOffset(e)),!1})},dragGeom:function(t,n,i){var s=this,o=this.$el.find("#"+t.join(",#")),u=this.$el.find("line."+t.join(",line.")),a=this.$el.find("path."+t.join(",path."));this.drag(function(t){n.left-=t.left,n.top-=t.top,o.each(function(){var t=e(this),i=r.getNodeById(t.attr("id"));t.css({left:i.x-=n.left,top:i.y-=n.top})}),u.each(function(){var e=this.getAttribute("class").split(" "),t=r.getNodeById(e[0]),n=r.getNodeById(e[1]);this.setAttribute("x1",t.x),this.setAttribute("y1",t.y),this.setAttribute("x2",n.x),this.setAttribute("y2",n.y)}),a.each(function(){var e=this.getAttribute("id"),t=r.getNodesForPolygon(e);this.setAttribute("d",s.getPathForNodes(t))}),n=t},null,i)},dragMarquee:function(n){function o(e,t){var n=Math.min(e.left,t.left),r=Math.max(e.left,t.left),i=Math.min(e.top,t.top),o=Math.max(e.top,t.top),u={x:n,y:i,left:n,top:i,width:r-n,height:o-i};return s.css(u),u}var s=e("#marquee").show();o(n,n),this.drag(function(e){o(n,e)},function(e){t.each(r.getNodesInRect(o(n,e)),function(e){i.select(e)}),s.hide()})},touchNode:function(e,t,n,r){var s=i.contains(e),o=!1;n?(s=i.toggle(e),o=!0):s||(i.deselectAll(),i.select(e),s=!0),s&&this.dragGeom(i.items,t,function(t){!t&&!o&&(i.deselectAll(),i.select(e))})},touchPoly:function(e,t,n,s){if(s){var o=r.getPolygonById(e).nodes;i.setSelection(o)}else n||i.deselectAll(),i.toggle(e)&&this.dragGeom(r.getPolygonById(e).nodes,t)},touchCanvas:function(e,t,n){n?r.addNode(e.left,e.top):(t||i.deselectAll(),this.dragMarquee(e))},onTouch:function(t){var n=e(t.target),r=(new Date).getTime(),i=r-this.lastTouch<200,s=this.localizeEventOffset(t),o;return n=n.is("li > span")?n.parent():n,o=n.attr("id"),this.lastTouch=r,n.is("li")?this.touchNode(o,s,t.shiftKey,i):n.is("path")?this.touchPoly(o,s,t.shiftKey,i):this.touchCanvas(s,t.shiftKey,i),!1}});return new o})